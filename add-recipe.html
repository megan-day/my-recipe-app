<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Recipe</title>
  <link rel="stylesheet" href="style.css" />
  <script src="recipes.js" defer></script>
</head>
<body>
  <div class="page-container">
    <nav class="top-nav">
      <a href="index.html">Home</a>
      <a href="search.html">Search</a>
    </nav>

    <header class="recipe-header">
      <h1>Add a Recipe</h1>
      <p>Enter recipe data. Tags are optional (comma separated). You can export all recipes to JSON.</p>
    </header>

    <div class="recipe-card">
      <div class="recipe-column">
        <h2>Recipe Details</h2>

        <div style="margin-bottom:8px">
          <label>Title</label>
          <input id="title" type="text" placeholder="Recipe title" />
        </div>

        <div style="margin-bottom:8px">
          <label>Description</label>
          <textarea id="description" rows="3" placeholder="Short description" style="width:100%;"></textarea>
        </div>

        <div style="margin-bottom:8px">
          <label>Tags (comma separated)</label>
          <input id="tags" type="text" placeholder="bread, vegan, quick" />
        </div>

       <h3>Ingredients</h3>

<div style="margin-bottom:8px">
  <label>Ingredient Name</label>
  <input id="new-ingredient-name" type="text" placeholder="Name" list="saved-ingredients" />
  <datalist id="saved-ingredients"></datalist>
</div>

<div style="margin-bottom:8px">
  <label>Quantity (g)</label>
  <input id="new-ingredient-qty" type="number" placeholder="Quantity" />
</div>

<button id="add-ingredient-btn" class="small-btn">Add Ingredient</button>

<div id="ingredient-list" style="margin-top:8px;"></div>


        <h3>Steps</h3>
        <div id="stepsRows" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px"></div>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <button id="addStepRow" class="small-btn">+ Add step</button>
          <button id="clearSteps" class="small-btn">Clear</button>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="saveRecipe">Save to browser</button>
          <button id="previewRecipe" class="small-btn">Preview</button>
          <button id="exportJson" class="small-btn">Export all recipes (JSON)</button>
        </div>
      </div>

      <div class="recipe-column">
        <h2>Preview</h2>
        <div id="previewArea" style="min-height:200px"></div>
      </div>
    </div>
  </div>

<script>


  document.getElementById('saveRecipe').addEventListener('click', ()=>{
    const recipe = gatherForm();
    if(!recipe.title) return alert('Title required');
    addUserRecipe(recipe);
    alert('Saved locally. It will appear on the Home page.');
  });

  document.getElementById('previewRecipe').addEventListener('click', ()=> {
    const recipe = gatherForm();
    renderPreview(recipe);
  });

  document.getElementById('exportJson').addEventListener('click', ()=> exportAllRecipes());

  // remove-row delegated
  document.body.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.classList.contains('remove-row')){
      ev.target.closest('.form-row').remove();
    }
  });

  // start with 3 ingredient rows and 3 steps for convenience
  for(let i=0;i<3;i++){ ingContainer().appendChild(makeIngRow()); stepsContainer().appendChild(makeStepRow()); }
});

/* read form into recipe object */
function gatherForm(){
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  const tagsRaw = document.getElementById('tags').value.trim();
  const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];

  const ingredients = currentIngredients.map(i => ({
  name: i.name,
  baseQuantity: i.quantity,
  quantity: i.quantity,
  macros: i.macros
}));

    };
  }).filter(i=>i.name);

  const steps = Array.from(document.querySelectorAll('#stepsRows .form-row .step-txt')).map(i=>i.value.trim()).filter(Boolean);

  const id = makeId('r');

  return { id, title, description, ingredients, steps, tags };
}

/* render preview similar to recipe.html */
function renderPreview(recipe){
  if(!recipe) { previewArea().innerHTML = '<p>No preview</p>'; return; }
  const div = document.createElement('div');
  div.innerHTML = `
    <h3>${escapeHtml(recipe.title)}</h3>
    <p>${escapeHtml(recipe.description || '')}</p>
    <h4>Ingredients</h4>
    <ul>
      ${recipe.ingredients.map(i=>`<li>${escapeHtml(i.name)} — ${i.baseQuantity} g</li>`).join('')}
    </ul>
    <h4>Steps</h4>
    <ol>${recipe.steps.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol>
    <div class="tags">${(recipe.tags||[]).join(' • ')}</div>
  `;
  previewArea().innerHTML = '';
  previewArea().appendChild(div);
}
<script>
/* ------------------------------
   Helper functions
------------------------------ */

// Escape HTML for safe rendering
function escapeHtml(s) {
  return (s||'').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

// Create a step input row
function makeStepRow(text='') {
  const wrapper = document.createElement('div');
  wrapper.className = 'form-row';
  wrapper.innerHTML = `
    <input class="step-txt" type="text" placeholder="Step description" value="${escapeHtml(text)}" />
    <button class="small-btn remove-row">✖</button>
  `;
  return wrapper;
}

// Render recipe preview
function renderPreview(recipe) {
  const previewArea = document.getElementById('previewArea');
  if(!recipe) {
    previewArea.innerHTML = '<p>No preview</p>';
    return;
  }
  const div = document.createElement('div');
  div.innerHTML = `
    <h3>${escapeHtml(recipe.title)}</h3>
    <p>${escapeHtml(recipe.description || '')}</p>
    <h4>Ingredients</h4>
    <ul>
      ${recipe.ingredients.map(i=>`<li>${escapeHtml(i.name)} — ${i.baseQuantity} g</li>`).join('')}
    </ul>
    <h4>Steps</h4>
    <ol>${recipe.steps.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol>
    <div class="tags">${(recipe.tags||[]).join(' • ')}</div>
  `;
  previewArea.innerHTML = '';
  previewArea.appendChild(div);
}

// Gather form data into recipe object
function gatherForm(currentIngredients) {
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  const tagsRaw = document.getElementById('tags').value.trim();
  const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];

  const ingredients = currentIngredients.map(i => ({
    name: i.name,
    baseQuantity: i.quantity,
    quantity: i.quantity,
    macros: i.macros
  }));

  const steps = Array.from(document.querySelectorAll('#stepsRows .form-row .step-txt'))
    .map(i=>i.value.trim())
    .filter(Boolean);

  const id = makeId('r');

  return { id, title, description, ingredients, steps, tags };
}
</script>

<script>
/* ------------------------------
   DOM & Event Logic
------------------------------ */
document.addEventListener("DOMContentLoaded", () => {

  // --- Ingredients ---
  const nameInput = document.getElementById("new-ingredient-name");
  const qtyInput = document.getElementById("new-ingredient-qty");
  const addBtn = document.getElementById("add-ingredient-btn");
  const listDiv = document.getElementById("ingredient-list");
  const datalist = document.getElementById("saved-ingredients");

  const currentIngredients = []; // Ingredients for this recipe

  // Fill datalist with saved ingredients from localStorage
  function updateDatalist() {
    const saved = loadUserIngredients();
    datalist.innerHTML = ""; // clear
    saved.forEach(ing => {
      const option = document.createElement("option");
      option.value = ing.name;
      datalist.appendChild(option);
    });
  }

  updateDatalist();

  // Render current ingredients list
  function renderIngredients() {
    listDiv.innerHTML = ""; // clear
    currentIngredients.forEach((ing, idx) => {
      const div = document.createElement("div");
      div.textContent = `${ing.name} — ${ing.quantity}`;
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "❌";
      removeBtn.addEventListener("click", () => {
        currentIngredients.splice(idx, 1);
        renderIngredients();
      });
      div.appendChild(removeBtn);
      listDiv.appendChild(div);
    });
  }

  // Auto-fill quantity if name matches saved ingredient
  nameInput.addEventListener("input", () => {
    const found = findUserIngredientByName(nameInput.value.trim());
    if (found) {
      qtyInput.value = found.quantity || "";
    }
  });

  // Add ingredient button
  addBtn.addEventListener("click", () => {
    const name = nameInput.value.trim();
    const qty = parseFloat(qtyInput.value);
    if (!name || isNaN(qty)) {
      alert("Please enter a valid name and quantity.");
      return;
    }

    const ingredient = {
      name,
      quantity: qty,
      macros: { calories: 0, protein: 0, carbs: 0, fat: 0 } // default
    };

    addUserIngredient(ingredient); // Save to personal database
    updateDatalist();

    currentIngredients.push(ingredient);
    renderIngredients();

    nameInput.value = "";
    qtyInput.value = "";
  });

  // --- Steps ---
  const stepsContainer = document.getElementById('stepsRows');
  const addStepBtn = document.getElementById('addStepRow');
  const clearStepsBtn = document.getElementById('clearSteps');

  addStepBtn.addEventListener("click", () => {
    stepsContainer.appendChild(makeStepRow());
  });

  clearStepsBtn.addEventListener("click", () => {
    stepsContainer.innerHTML = "";
  });

  // Start with 3 empty steps
  for(let i=0; i<3; i++) {
    stepsContainer.appendChild(makeStepRow());
  }

  // --- Save / Preview / Export ---
  document.getElementById('saveRecipe').addEventListener('click', ()=>{
    const recipe = gatherForm(currentIngredients);
    if(!recipe.title) return alert('Title required');
    addUserRecipe(recipe);
    alert('Saved locally. It will appear on the Home page.');
  });

  document.getElementById('previewRecipe').addEventListener('click', ()=>{
    const recipe = gatherForm(currentIngredients);
    renderPreview(recipe);
  });

  document.getElementById('exportJson').addEventListener('click', ()=> exportAllRecipes());

  // --- Remove step delegate ---
  document.body.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.classList.contains('remove-row')){
      ev.target.closest('.form-row').remove();
    }
  });

});
</script>



</body>
</html>



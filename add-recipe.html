<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Recipe</title>
  <link rel="stylesheet" href="style.css" />
  <script src="recipes.js" defer></script>
</head>
<body>
  <div class="page-container">
    <nav class="top-nav">
      <a href="index.html">Home</a>
      <a href="search.html">Search</a>
    </nav>

    <header class="recipe-header">
      <h1>Add a Recipe</h1>
      <p>Enter recipe data. Tags are optional (comma separated).</p>
    </header>

    <div class="recipe-card">
      <div class="recipe-column">
        <h2>Recipe Details</h2>

        <div style="margin-bottom:8px">
          <label>Title</label>
          <input id="title" type="text" placeholder="Recipe title" />
        </div>

        <div style="margin-bottom:8px">
          <label>Description</label>
          <textarea id="description" rows="3" placeholder="Short description" style="width:100%;"></textarea>
        </div>

        <div style="margin-bottom:8px">
          <label>Tags (comma separated)</label>
          <input id="tags" type="text" placeholder="bread, vegan, quick" />
        </div>

        <h3>Ingredients</h3>

        <div style="margin-bottom:8px">
          <label>Ingredient Name</label>
          <input id="new-ingredient-name" type="text" placeholder="Name" list="saved-ingredients" />
          <datalist id="saved-ingredients"></datalist>
        </div>

        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:8px;">
          <div>
            <label>Quantity (g)</label>
            <input id="new-ingredient-qty" type="number" placeholder="g" />
          </div>
          <div>
            <label>Calories</label>
            <input id="new-ingredient-cal" type="number" placeholder="kcal" />
          </div>
          <div>
            <label>Protein</label>
            <input id="new-ingredient-pro" type="number" placeholder="g" />
          </div>
          <div>
            <label>Carbs</label>
            <input id="new-ingredient-carb" type="number" placeholder="g" />
          </div>
          <div>
            <label>Fat</label>
            <input id="new-ingredient-fat" type="number" placeholder="g" />
          </div>
        </div>

        <button id="add-ingredient-btn" class="small-btn">Add Ingredient</button>
        <div id="ingredient-list" style="margin-top:8px;"></div>

        <h3>Steps</h3>
        <div id="stepsRows" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <button id="addStepRow" class="small-btn">+ Add step</button>
          <button id="clearSteps" class="small-btn">Clear</button>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="saveRecipe">Save to browser</button>
          <button id="previewRecipe" class="small-btn">Preview</button>
          <button id="exportJson" class="small-btn">Export all recipes (JSON)</button>
        </div>
      </div>

      <div class="recipe-column">
        <h2>Preview</h2>
        <div id="previewArea" style="min-height:200px"></div>
      </div>
    </div>
  </div>

<script>
/* ------------------------------
   Utility Helpers
------------------------------ */
function escapeHtml(s) {
  return (s||'').toString()
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

function makeStepRow(text='') {
  const wrapper = document.createElement('div');
  wrapper.className = 'form-row';
  wrapper.innerHTML = `
    <input class="step-txt" type="text" placeholder="Step description" value="${escapeHtml(text)}" />
    <button class="small-btn remove-row">âœ–</button>
  `;
  return wrapper;
}

/* ------------------------------
   MAIN LOGIC
------------------------------ */
document.addEventListener("DOMContentLoaded", () => {
  const nameInput = document.getElementById("new-ingredient-name");
  const qtyInput = document.getElementById("new-ingredient-qty");
  const calInput = document.getElementById("new-ingredient-cal");
  const proInput = document.getElementById("new-ingredient-pro");
  const carbInput = document.getElementById("new-ingredient-carb");
  const fatInput = document.getElementById("new-ingredient-fat");
  const addBtn = document.getElementById("add-ingredient-btn");
  const listDiv = document.getElementById("ingredient-list");
  const datalist = document.getElementById("saved-ingredients");
  const stepsContainer = document.getElementById('stepsRows');
  const addStepBtn = document.getElementById('addStepRow');
  const clearStepsBtn = document.getElementById('clearSteps');

  const currentIngredients = [];

  /* --- Load existing ingredients --- */
  function updateDatalist() {
    const saved = loadUserIngredients();
    datalist.innerHTML = "";
    saved.forEach(ing => {
      const option = document.createElement("option");
      option.value = ing.name;
      datalist.appendChild(option);
    });
  }
  updateDatalist();

  /* --- Render ingredients list --- */
  function renderIngredients() {
    listDiv.innerHTML = "";
    currentIngredients.forEach((ing, idx) => {
      const div = document.createElement("div");
      div.innerHTML = `${ing.name} â€” ${ing.quantity}g | ðŸ”¥${ing.macros.calories} kcal, ðŸ¥©${ing.macros.protein}P, ðŸž${ing.macros.carbs}C, ðŸ§ˆ${ing.macros.fat}F`;
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "âŒ";
      removeBtn.addEventListener("click", () => {
        currentIngredients.splice(idx, 1);
        renderIngredients();
      });
      div.appendChild(removeBtn);
      listDiv.appendChild(div);
    });
  }

  /* --- Autofill macros if ingredient exists --- */
  nameInput.addEventListener("input", () => {
    const found = findUserIngredientByName(nameInput.value.trim());
    if (found) {
      qtyInput.value = found.quantity || "";
      calInput.value = found.macros.calories || "";
      proInput.value = found.macros.protein || "";
      carbInput.value = found.macros.carbs || "";
      fatInput.value = found.macros.fat || "";
    }
  });

  /* --- Add ingredient button --- */
  addBtn.addEventListener("click", () => {
    const name = nameInput.value.trim();
    const qty = parseFloat(qtyInput.value);
    const calories = parseFloat(calInput.value) || 0;
    const protein = parseFloat(proInput.value) || 0;
    const carbs = parseFloat(carbInput.value) || 0;
    const fat = parseFloat(fatInput.value) || 0;

    if (!name || isNaN(qty)) {
      alert("Please enter a valid name and quantity.");
      return;
    }

    const ingredient = {
      name,
      quantity: qty,
      macros: { calories, protein, carbs, fat }
    };

    addUserIngredient(ingredient);
    updateDatalist();

    currentIngredients.push(ingredient);
    renderIngredients();

    nameInput.value = "";
    qtyInput.value = "";
    calInput.value = "";
    proInput.value = "";
    carbInput.value = "";
    fatInput.value = "";
  });

  /* --- Steps logic --- */
  addStepBtn.addEventListener("click", () => {
    stepsContainer.appendChild(makeStepRow());
  });

  clearStepsBtn.addEventListener("click", () => {
    stepsContainer.innerHTML = "";
  });

  // Start with 3 empty steps
  for(let i=0;i<3;i++){ stepsContainer.appendChild(makeStepRow()); }

  /* --- Save / Preview / Export --- */
  document.getElementById('saveRecipe').addEventListener('click', ()=> {
    const recipe = gatherForm(currentIngredients);
    if(!recipe.title) return alert('Title required');
    addUserRecipe(recipe);
    alert('Saved locally. It will appear on the Home page.');
  });

  document.getElementById('previewRecipe').addEventListener('click', ()=> {
    const recipe = gatherForm(currentIngredients);
    renderPreview(recipe);
  });

  document.getElementById('exportJson').addEventListener('click', ()=> exportAllRecipes());

  /* --- Remove step handler --- */
  document.body.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.classList.contains('remove-row')){
      ev.target.closest('.form-row').remove();
    }
  });
});

/* ------------------------------
   Form gather & preview
------------------------------ */
function gatherForm(currentIngredients){
  const title = document.getElementById('title').value.trim();
  const description = document.getElementById('description').value.trim();
  const tagsRaw = document.getElementById('tags').value.trim();
  const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];

  const ingredients = currentIngredients.map(i => ({
    name: i.name,
    baseQuantity: i.quantity,
    quantity: i.quantity,
    macros: i.macros
  }));

  const steps = Array.from(document.querySelectorAll('#stepsRows .form-row .step-txt'))
    .map(i=>i.value.trim())
    .filter(Boolean);

  const id = makeId('r');

  return { id, title, description, ingredients, steps, tags };
}

function renderPreview(recipe){
  const previewArea = document.getElementById('previewArea');
  if(!recipe){ previewArea.innerHTML = '<p>No preview</p>'; return; }
  const div = document.createElement('div');
  div.innerHTML = `
    <h3>${escapeHtml(recipe.title)}</h3>
    <p>${escapeHtml(recipe.description || '')}</p>
    <h4>Ingredients</h4>
    <ul>
      ${recipe.ingredients.map(i=>`<li>${escapeHtml(i.name)} â€” ${i.quantity}g (${i.macros.calories} kcal, ${i.macros.protein}P/${i.macros.carbs}C/${i.macros.fat}F)</li>`).join('')}
    </ul>
    <h4>Steps</h4>
    <ol>${recipe.steps.map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol>
    <div class="tags">${(recipe.tags||[]).join(' â€¢ ')}</div>
  `;
  previewArea.innerHTML = '';
  previewArea.appendChild(div);
}
</script>
</body>
</html>
